#!/bin/sh

##DEBIAN !/bin/ash
# Device startup script
#
# author walter.dedonato@unina.it
# modified by srikanth@gatech.edu
# modified by sburnett@cc.gatech.edu
# modified by gmartins@cc.gatech.edu

# Load configuration
. /etc/bismark/bismark.conf

# Create temporary tree
mkdir -p /tmp/bismark/var

# Set the device identifier
PRE="UN"
#what is my platform
if [ -f /etc/issue ];
then
   if  grep -q "^\(Debian\|Ubuntu\|Raspbian\|Kali\)" /etc/issue;
   then 
     ostype=$(cat /etc/issue | cut -c 1-4)
     case "$ostype" in
       Rasp) PRE="PI";;
       Debi|Ubun|Kali) PRE="DL";;
     esac
   fi
else #no issue file (an old openwrt?)
  PRE="OW"
fi

#if there's any mac associated w default gw route, use it
macif=$(/sbin/route -n | grep "^0.0.0.0" | head -n 1| awk '{ print $ 8}')
if [ -z $macif ];
then
  macif="eth0" #default to eth0
fi

if [ ! -e /etc/bismark/ID ];
then
  case "$PRE" in
     PI|DL)
        lanmac=0x$(/sbin/ifconfig $macif | awk '/ether / { gsub(":","", $2); print $2 }')
        printf "$PRE%012X\n" $((lanmac & 0xFDFFFFFFFFFF)) > /etc/bismark/ID
     ;;
     OW)
        if [ -e /lib/ar71xx.sh ]; then
            . /lib/ar71xx.sh
            board=$(ar71xx_board_name)
            case $board in
            wndr3*00*)
                macif=$LAN_IF
                ;;
            tl-wdr*)
                macif=wlan1
                ;;
            *)
                macif=$LAN_IF
            ;;
            esac
        fi
        lanmac=0x$(ifconfig $macif | awk '/HWaddr / { gsub(":","", $5); print $5 }')
        printf "OW%012X\n" $((lanmac & 0xFDFFFFFFFFFF)) > /etc/bismark/ID
        uci set system.@system[0].hostname=$(cat /etc/bismark/ID)
        uci commit system
        cat /etc/bismark/ID > /proc/sys/kernel/hostname
     ;;
     *)
        echo UN$(date +%y%m%d%H)$(awk 'BEGIN {srand(); printf "%04X\n", rand()*65535}') > /etc/bismark/ID
     ;;
  esac  
else
  if ! grep -qE "^(PI|DL|OW|UN)[0-9A-F]{12}" /etc/bismark/ID;
  then
     echo $PRE$(date +%y%m%d%H)$(awk 'BEGIN {srand(); printf "%04X\n", rand()*65535}') > /etc/bismark/ID
  fi
fi

[ -e /www/index.html -a -e /www/index.htm ] && rm -f /www/index.html

if [ -f /etc/opkg.conf ]; then
    DEVID=$(cat /etc/bismark/ID)
    if ! grep -q $DEVID /etc/opkg.conf; then
        sed -i -e "s!updates-device!updates-device/$DEVID!g" /etc/opkg.conf
        sed -i -e "s!experiments-device!experiments-device/$DEVID!g" /etc/opkg.conf
    fi
fi

# Conf changes
if [ -x /usr/bin/bismark-action ]; then
    /usr/bin/bismark-action mgmtconfupdate
fi

# start bismark-sshd
if [ -x /usr/bin/bismark-sshd ]; then
    /usr/bin/bismark-sshd
fi

# don't run netserver on boot
if [ -x /etc/init.d/netserver ]; then
    /etc/init.d/netserver stop
    /etc/init.d/netserver disable
fi

# don't run nodogsplash on boot
if [ -x /etc/init.d/nodogsplash ]; then
    /etc/init.d/nodogsplash stop
    /etc/init.d/nodogsplash disable
fi
